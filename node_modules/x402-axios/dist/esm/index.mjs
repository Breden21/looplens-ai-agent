// src/index.ts
import {
  ChainIdToNetwork,
  PaymentRequirementsSchema,
  isMultiNetworkSigner,
  isSvmSignerWallet,
  evm
} from "x402/types";
import {
  createPaymentHeader,
  selectPaymentRequirements
} from "x402/client";
import { decodeXPaymentResponse } from "x402/shared";
import { createSigner } from "x402/types";
function withPaymentInterceptor(axiosClient, walletClient, paymentRequirementsSelector = selectPaymentRequirements, config) {
  axiosClient.interceptors.response.use(
    (response) => response,
    async (error) => {
      var _a;
      if (!error.response || error.response.status !== 402) {
        return Promise.reject(error);
      }
      try {
        const originalConfig = error.config;
        if (!originalConfig || !originalConfig.headers) {
          return Promise.reject(new Error("Missing axios request configuration"));
        }
        if (originalConfig.__is402Retry) {
          return Promise.reject(error);
        }
        const { x402Version, accepts } = error.response.data;
        const parsed = accepts.map((x) => PaymentRequirementsSchema.parse(x));
        const network = isMultiNetworkSigner(walletClient) ? void 0 : evm.isSignerWallet(walletClient) ? ChainIdToNetwork[(_a = walletClient.chain) == null ? void 0 : _a.id] : isSvmSignerWallet(walletClient) ? ["solana", "solana-devnet"] : void 0;
        const selectedPaymentRequirements = paymentRequirementsSelector(parsed, network, "exact");
        const paymentHeader = await createPaymentHeader(
          walletClient,
          x402Version,
          selectedPaymentRequirements,
          config
        );
        originalConfig.__is402Retry = true;
        originalConfig.headers["X-PAYMENT"] = paymentHeader;
        originalConfig.headers["Access-Control-Expose-Headers"] = "X-PAYMENT-RESPONSE";
        const secondResponse = await axiosClient.request(originalConfig);
        return secondResponse;
      } catch (paymentError) {
        return Promise.reject(paymentError);
      }
    }
  );
  return axiosClient;
}
export {
  createSigner,
  decodeXPaymentResponse,
  withPaymentInterceptor
};
//# sourceMappingURL=index.mjs.map